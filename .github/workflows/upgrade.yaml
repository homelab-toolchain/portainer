name: Upgrade Version

on:
  schedule:
    - cron: '0 8 * * *' # every day 8am
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set Git Identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Upgrade Version
        id: upgrade
        shell: bash
        run: |
          set -euo pipefail

          COMPOSE_FILE="docker-compose.yml"

          echo "Fetching latest Portainer LTS release tag..."
          LATEST_TAG="$(curl -s https://api.github.com/repos/portainer/portainer/releases?per_page=30 \
            | jq -r '
              [.[] | select(.name // "" | test("LTS"; "i"))]
              | sort_by(.published_at) | reverse
              | .[0].tag_name
            ')"

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Could not determine latest LTS tag from GitHub releases." >&2
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          LATEST_VERSION="${LATEST_TAG#v}"
          echo "Latest LTS tag: $LATEST_TAG (version: $LATEST_VERSION)"

          CURRENT_IMAGE_LINE="$(grep -E '^[[:space:]]*image:[[:space:]]*["'"'"']?portainer/portainer-ce:' "$COMPOSE_FILE" | head -n1 || true)"
          if [ -z "$CURRENT_IMAGE_LINE" ]; then
            echo "Could not find a portainer/portainer-ce image line in $COMPOSE_FILE" >&2
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

          CURRENT_VERSION="$(echo "$CURRENT_IMAGE_LINE" | sed -E 's/.*portainer\/portainer-ce:([^"'"'"'[:space:]]+).*/\1/')"
          echo "Current version in $COMPOSE_FILE: $CURRENT_VERSION"

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "No change needed. Skipping remaining steps."
            echo "changed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Updating $COMPOSE_FILE to $LATEST_VERSION ..."
          sed -i -E "s|(image:[[:space:]]*[\"']?portainer/portainer-ce:)[^\"'[:space:]]+|\1${LATEST_VERSION}|" "$COMPOSE_FILE"

          echo "changed=true" >> "$GITHUB_OUTPUT"
          echo "new_version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"

      - name: Set up Docker
        if: steps.upgrade.outputs.changed == 'true'
        uses: docker/setup-docker-action@e61617a16c407a86262fb923c35a616ddbe070b3 # v4

      - name: Run Docker Container
        if: steps.upgrade.outputs.changed == 'true'
        run: |
          set -euo pipefail
          docker compose up -d

      - name: Install httpie
        if: steps.upgrade.outputs.changed == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y httpie

      - name: Test
        if: steps.upgrade.outputs.changed == 'true'
        run: |
          http --ignore-stdin --verify=no POST https://localhost:9443/api/auth Username="admin" Password="admin"

      - name: Commit & Push
        if: steps.upgrade.outputs.changed == 'true'
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail

          git add .

          if git diff --cached --quiet; then
            echo "Nothing to commit and push."
            exit 0
          fi

          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

          LAST_SUBJECT="$(git log -1 --pretty=%s || echo "")"
          BASE_SUBJECT="chore(bot): increase portainer version"

          if [ "$LAST_SUBJECT" = "$BASE_SUBJECT" ]; then
            echo "Last commit has same subject -> creating fixup commit."
            git commit --amend -m "$BASE_SUBJECT"
            git push --force-with-lease origin HEAD
          else
            git commit -m "$BASE_SUBJECT"
            git push origin HEAD
          fi